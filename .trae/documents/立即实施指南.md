# SQLå®æˆ˜å¹³å°ç«‹å³å®æ–½æŒ‡å—

## ğŸš€ 5åˆ†é’Ÿå¿«é€Ÿå¯åŠ¨ä¼˜åŒ–

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“å‡çº§ï¼ˆç«‹å³æ‰§è¡Œï¼‰

```bash
# åœ¨ sql-learn-backend ç›®å½•ä¸‹æ‰§è¡Œ
python -m alembic revision --autogenerate -m "enhance_exercise_system"
python -m alembic upgrade head
```

### ç¬¬äºŒæ­¥ï¼šåˆ›å»ºä¼˜åŒ–åçš„APIï¼ˆå¤åˆ¶ç²˜è´´å³å¯ç”¨ï¼‰

åˆ›å»ºæ–‡ä»¶ `sql-learn-backend/app/api/v1/exercises.py`ï¼š

```python
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import List, Optional
from pydantic import BaseModel
from datetime import datetime

from ...database import get_db
from ...models import Exercise, User, UserExerciseRecord
from ..auth import get_current_user

router = APIRouter(prefix="/api/v1/exercises", tags=["exercises"])

class ExerciseDetail(BaseModel):
    id: int
    title: str
    description: str
    difficulty: str
    points: int
    category: str
    tags: List[str]
    sample_data: dict
    hints: List[str]
    expected_result: List[dict]

class ExerciseListParams(BaseModel):
    difficulty: Optional[str] = None
    category: Optional[str] = None
    tags: Optional[List[str]] = None
    status: Optional[str] = "all"  # all, todo, completed
    limit: int = Query(default=20, le=100)

@router.get("/list", response_model=List[dict])
def get_exercises(
    params: ExerciseListParams = Depends(),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """è·å–ç»ƒä¹ é¢˜åˆ—è¡¨ï¼Œæ”¯æŒç­›é€‰å’Œåˆ†é¡µ"""
    query = db.query(Exercise)
    
    if params.difficulty:
        query = query.filter(Exercise.difficulty == params.difficulty)
    
    # è·å–ç”¨æˆ·å®Œæˆè®°å½•
    completed_ids = set()
    if params.status != "all":
        records = db.query(UserExerciseRecord.exercise_id).filter(
            UserExerciseRecord.user_id == current_user.id,
            UserExerciseRecord.is_completed == (params.status == "completed")
        ).all()
        completed_ids = {r.exercise_id for r in records}
        query = query.filter(Exercise.id.in_(completed_ids) if params.status == "completed" 
                           else ~Exercise.id.in_(completed_ids))
    
    exercises = query.limit(params.limit).all()
    
    return [{
        "id": e.id,
        "title": e.title,
        "description": e.description,
        "difficulty": e.difficulty,
        "points": e.points,
        "is_completed": e.id in completed_ids
    } for e in exercises]

@router.get("/{exercise_id}", response_model=ExerciseDetail)
def get_exercise_detail(
    exercise_id: int,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """è·å–é¢˜ç›®è¯¦ç»†ä¿¡æ¯"""
    exercise = db.query(Exercise).filter(Exercise.id == exercise_id).first()
    if not exercise:
        raise HTTPException(status_code=404, detail="é¢˜ç›®ä¸å­˜åœ¨")
    
    return {
        "id": exercise.id,
        "title": exercise.title,
        "description": exercise.description,
        "difficulty": exercise.difficulty,
        "points": exercise.points,
        "category": exercise.category or "åŸºç¡€ç»ƒä¹ ",
        "tags": exercise.tags or [],
        "sample_data": exercise.sample_data or {},
        "hints": exercise.hints or [],
        "expected_result": exercise.expected_result or []
    }
```

### ç¬¬ä¸‰æ­¥ï¼šå‰ç«¯APIé›†æˆï¼ˆç«‹å³å¯ç”¨ï¼‰

åˆ›å»ºæ–‡ä»¶ `sql-learn/src/api/exercise.ts`ï¼š

```typescript
import request from '@/utils/request'

export interface Exercise {
  id: number
  title: string
  description: string
  difficulty: 'easy' | 'medium' | 'hard'
  points: number
  is_completed: boolean
}

export interface ExerciseDetail extends Exercise {
  category: string
  tags: string[]
  sample_data: {
    tables: Array<{
      name: string
      columns: string[]
      data: Record<string, any>[]
    }>
  }
  hints: string[]
  expected_result: Record<string, any>[]
}

export const exerciseApi = {
  // è·å–ç»ƒä¹ åˆ—è¡¨
  async getList(params: {
    difficulty?: string
    category?: string
    status?: 'all' | 'todo' | 'completed'
    limit?: number
  }) {
    return request.get('/api/v1/exercises/list', { params })
  },

  // è·å–é¢˜ç›®è¯¦æƒ…
  async getDetail(id: number) {
    return request.get(`/api/v1/exercises/${id}`)
  },

  // æäº¤ç­”æ¡ˆ
  async submitAnswer(exerciseId: number, sql: string, result: any) {
    return request.post('/api/v1/exercises/submit', {
      exercise_id: exerciseId,
      sql,
      result
    })
  }
}
```

### ç¬¬å››æ­¥ï¼šä¼˜åŒ–ç»ƒä¹ é¡µé¢ï¼ˆç›´æ¥æ›¿æ¢ï¼‰

ä¿®æ”¹ `sql-learn/src/pages/Practice.vue`ï¼Œæ›¿æ¢ç°æœ‰ä»£ç ï¼š

```vue
<template>
  <div class="practice-container">
    <el-row :gutter="20">
      <!-- å·¦ä¾§ç­›é€‰é¢æ¿ -->
      <el-col :xs="24" :lg="6">
        <el-card class="filter-card">
          <template #header>
            <div class="card-header">
              <span>ç­›é€‰æ¡ä»¶</span>
              <el-button type="primary" size="small" @click="loadExercises">
                åˆ·æ–°
              </el-button>
            </div>
          </template>
          
          <el-form label-position="top">
            <el-form-item label="éš¾åº¦">
              <el-select v-model="filters.difficulty" clearable>
                <el-option label="å…¨éƒ¨" value="" />
                <el-option label="ç®€å•" value="easy" />
                <el-option label="ä¸­ç­‰" value="medium" />
                <el-option label="å›°éš¾" value="hard" />
              </el-select>
            </el-form-item>
            
            <el-form-item label="çŠ¶æ€">
              <el-radio-group v-model="filters.status">
                <el-radio value="all">å…¨éƒ¨</el-radio>
                <el-radio value="todo">å¾…å®Œæˆ</el-radio>
                <el-radio value="completed">å·²å®Œæˆ</el-radio>
              </el-radio-group>
            </el-form-item>
          </el-form>
        </el-card>

        <!-- é¢˜ç›®åˆ—è¡¨ -->
        <el-card class="exercise-list" style="margin-top: 20px">
          <div
            v-for="exercise in exercises"
            :key="exercise.id"
            class="exercise-item"
            :class="{ active: currentExercise?.id === exercise.id }"
            @click="selectExercise(exercise)"
          >
            <div class="exercise-header">
              <el-tag :type="getDifficultyType(exercise.difficulty)" size="small">
                {{ exercise.difficulty }}
              </el-tag>
              <el-icon v-if="exercise.is_completed" color="#67C23A">
                <Check />
              </el-icon>
            </div>
            <h4>{{ exercise.title }}</h4>
            <p>{{ exercise.description }}</p>
          </div>
        </el-card>
      </el-col>

      <!-- å³ä¾§ç­”é¢˜åŒºåŸŸ -->
      <el-col :xs="24" :lg="18">
        <div v-if="currentExercise" class="exercise-workspace">
          <!-- é¢˜ç›®è¯¦æƒ… -->
          <el-card>
            <template #header>
              <div class="card-header">
                <h3>{{ currentExercise.title }}</h3>
                <el-tag :type="getDifficultyType(currentExercise.difficulty)">
                  {{ currentExercise.difficulty }}
                </el-tag>
              </div>
            </template>
            
            <div class="exercise-content">
              <h4>é¢˜ç›®æè¿°</h4>
              <p>{{ currentExercise.description }}</p>
              
              <h4>ç¤ºä¾‹æ•°æ®</h4>
              <div class="sample-tables">
                <div
                  v-for="table in currentExercise.sample_data.tables"
                  :key="table.name"
                  class="sample-table"
                >
                  <h5>{{ table.name }}</h5>
                  <el-table :data="table.data" size="small">
                    <el-table-column
                      v-for="col in table.columns"
                      :key="col"
                      :prop="col"
                      :label="col"
                    />
                  </el-table>
                </div>
              </div>
            </div>
          </el-card>

          <!-- SQLç¼–è¾‘å™¨ -->
          <el-card style="margin-top: 20px">
            <template #header>
              <div class="card-header">
                <h3>SQLç¼–è¾‘å™¨</h3>
                <div>
                  <el-button
                    type="success"
                    :loading="executing"
                    @click="executeSQL"
                  >
                    <el-icon><CaretRight /></el-icon>
                    è¿è¡Œ
                  </el-button>
                  <el-button
                    type="primary"
                    :disabled="!executeResult"
                    @click="submitAnswer"
                  >
                    <el-icon><Check /></el-icon>
                    æäº¤ç­”æ¡ˆ
                  </el-button>
                </div>
              </div>
            </template>
            
            <el-input
              v-model="sqlCode"
              type="textarea"
              :rows="8"
              placeholder="åœ¨æ­¤è¾“å…¥SQLæŸ¥è¯¢è¯­å¥..."
            />
          </el-card>

          <!-- æŸ¥è¯¢ç»“æœ -->
          <el-card v-if="executeResult" style="margin-top: 20px">
            <template #header>
              <div class="card-header">
                <h3>æŸ¥è¯¢ç»“æœ</h3>
                <span>å…± {{ executeResult.row_count }} æ¡è®°å½•</span>
              </div>
            </template>
            
            <el-table :data="executeResult.data" max-height="400">
              <el-table-column
                v-for="col in executeResult.columns"
                :key="col"
                :prop="col"
                :label="col"
              />
            </el-table>
          </el-card>

          <!-- é”™è¯¯æç¤º -->
          <el-alert
            v-if="executeError"
            :title="executeError"
            type="error"
            show-icon
            style="margin-top: 20px"
          />
        </div>

        <el-empty v-else description="è¯·é€‰æ‹©ä¸€é“é¢˜ç›®å¼€å§‹ç»ƒä¹ " />
      </el-col>
    </el-row>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { exerciseApi } from '@/api/exercise'
import { sqlApi } from '@/api/sql'

const filters = ref({
  difficulty: '',
  status: 'all'
})

const exercises = ref([])
const currentExercise = ref(null)
const sqlCode = ref('')
const executing = ref(false)
const executeResult = ref(null)
const executeError = ref('')

const loadExercises = async () => {
  try {
    const response = await exerciseApi.getList(filters.value)
    exercises.value = response.data
  } catch (error) {
    ElMessage.error('åŠ è½½é¢˜ç›®å¤±è´¥')
  }
}

const selectExercise = (exercise: any) => {
  currentExercise.value = exercise
  sqlCode.value = ''
  executeResult.value = null
  executeError.value = ''
}

const executeSQL = async () => {
  if (!sqlCode.value.trim()) {
    ElMessage.warning('è¯·è¾“å…¥SQLè¯­å¥')
    return
  }
  
  executing.value = true
  executeError.value = ''
  
  try {
    const response = await sqlApi.execute({
      sql: sqlCode.value,
      exercise_id: currentExercise.value?.id
    })
    
    if (response.data.success) {
      executeResult.value = response.data
    } else {
      executeError.value = response.data.error_message
    }
  } catch (error) {
    executeError.value = 'æ‰§è¡Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥SQLè¯­æ³•'
  } finally {
    executing.value = false
  }
}

const submitAnswer = async () => {
  if (!executeResult.value) return
  
  try {
    await exerciseApi.submitAnswer(
      currentExercise.value.id,
      sqlCode.value,
      executeResult.value
    )
    ElMessage.success('ç­”æ¡ˆæäº¤æˆåŠŸï¼')
    loadExercises() // åˆ·æ–°çŠ¶æ€
  } catch (error) {
    ElMessage.error('æäº¤å¤±è´¥')
  }
}

const getDifficultyType = (difficulty: string) => {
  const map = {
    easy: 'success',
    medium: 'warning',
    hard: 'danger'
  }
  return map[difficulty] || 'info'
}

onMounted(() => {
  loadExercises()
})
</script>

<style scoped>
.practice-container {
  padding: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.exercise-item {
  padding: 15px;
  border: 1px solid #eee;
  border-radius: 8px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.3s;
}

.exercise-item:hover {
  border-color: #409EFF;
  box-shadow: 0 2px 8px rgba(64, 158, 255, 0.2);
}

.exercise-item.active {
  border-color: #409EFF;
  background-color: rgba(64, 158, 255, 0.1);
}

.exercise-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.sample-tables {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.sample-table h5 {
  margin-bottom: 10px;
  color: #606266;
}
</style>
```

### ç¬¬äº”æ­¥ï¼šæµ‹è¯•æ•°æ®ï¼ˆç«‹å³å¯¼å…¥ï¼‰

åˆ›å»ºæ–‡ä»¶ `sql-learn-backend/data/sample_exercises.sql`ï¼š

```sql
-- æ’å…¥ç¤ºä¾‹é¢˜ç›®æ•°æ®
INSERT INTO exercises (title, description, difficulty, points, category, sample_data, expected_result, hints) VALUES
('åŸºç¡€æŸ¥è¯¢', 'æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥çš„åŸºæœ¬ä¿¡æ¯', 'easy', 10, 'åŸºç¡€æŸ¥è¯¢', 
'{"tables": [{"name": "employees", "columns": ["id", "name", "department", "salary"], "data": [{"id": 1, "name": "å¼ ä¸‰", "department": "æŠ€æœ¯éƒ¨", "salary": 8000}, {"id": 2, "name": "æå››", "department": "é”€å”®éƒ¨", "salary": 6000}]}]}',
'[{"id": 1, "name": "å¼ ä¸‰", "department": "æŠ€æœ¯éƒ¨", "salary": 8000}, {"id": 2, "name": "æå››", "department": "é”€å”®éƒ¨", "salary": 6000}]',
'["ä½¿ç”¨SELECT * FROM employees", "æ³¨æ„è¡¨åçš„å¤§å°å†™"]'),

('æ¡ä»¶æŸ¥è¯¢', 'æŸ¥è¯¢å·¥èµ„å¤§äº7000çš„å‘˜å·¥', 'medium', 15, 'æ¡ä»¶æŸ¥è¯¢',
'{"tables": [{"name": "employees", "columns": ["id", "name", "department", "salary"], "data": [{"id": 1, "name": "å¼ ä¸‰", "department": "æŠ€æœ¯éƒ¨", "salary": 8000}, {"id": 2, "name": "æå››", "department": "é”€å”®éƒ¨", "salary": 6000}, {"id": 3, "name": "ç‹äº”", "department": "æŠ€æœ¯éƒ¨", "salary": 7500}]}]}',
'[{"id": 1, "name": "å¼ ä¸‰", "department": "æŠ€æœ¯éƒ¨", "salary": 8000}, {"id": 3, "name": "ç‹äº”", "department": "æŠ€æœ¯éƒ¨", "salary": 7500}]',
'["ä½¿ç”¨WHEREå­å¥è¿›è¡Œæ¡ä»¶ç­›é€‰", "æ¯”è¾ƒè¿ç®—ç¬¦çš„ä½¿ç”¨"]'),

('èšåˆæŸ¥è¯¢', 'ç»Ÿè®¡æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„', 'hard', 20, 'èšåˆæŸ¥è¯¢',
'{"tables": [{"name": "employees", "columns": ["id", "name", "department", "salary"], "data": [{"id": 1, "name": "å¼ ä¸‰", "department": "æŠ€æœ¯éƒ¨", "salary": 8000}, {"id": 2, "name": "æå››", "department": "é”€å”®éƒ¨", "salary": 6000}, {"id": 3, "name": "ç‹äº”", "department": "æŠ€æœ¯éƒ¨", "salary": 7500}, {"id": 4, "name": "èµµå…­", "department": "é”€å”®éƒ¨", "salary": 6500}]}]}',
'[{"department": "æŠ€æœ¯éƒ¨", "avg_salary": 7750}, {"department": "é”€å”®éƒ¨", "avg_salary": 6250}]',
'["ä½¿ç”¨GROUP BYè¿›è¡Œåˆ†ç»„", "ä½¿ç”¨AVG()èšåˆå‡½æ•°", "æ³¨æ„GROUP BYçš„è¯­æ³•"]');

-- æ’å…¥åˆ†ç±»æ•°æ®
INSERT INTO exercise_categories (name, description, icon, sort_order) VALUES
('åŸºç¡€æŸ¥è¯¢', 'SELECTè¯­å¥çš„åŸºæœ¬ä½¿ç”¨', 'document', 1),
('æ¡ä»¶æŸ¥è¯¢', 'WHEREå­å¥å’Œæ¡ä»¶ç­›é€‰', 'filter', 2),
('èšåˆæŸ¥è¯¢', 'GROUP BYå’Œèšåˆå‡½æ•°', 'data-analysis', 3),
('è¿æ¥æŸ¥è¯¢', 'å¤šè¡¨è¿æ¥æ“ä½œ', 'link', 4),
('å­æŸ¥è¯¢', 'åµŒå¥—æŸ¥è¯¢è¯­å¥', 'share', 5);
```

### å¯åŠ¨å‘½ä»¤

```bash
# 1. å¯åŠ¨åç«¯
cd sql-learn-backend
pip install -r requirements.txt
python -m uvicorn app.main:app --reload --port 8000

# 2. å¯åŠ¨å‰ç«¯
cd sql-learn
npm install
npm run dev

# 3. å¯¼å…¥æµ‹è¯•æ•°æ®
cd sql-learn-backend
python -c "from app.database import SessionLocal; from app.models import *; db = SessionLocal(); exec(open('data/sample_exercises.sql').read())"
```

## âœ… éªŒè¯æ­¥éª¤

1. **è®¿é—®å‰ç«¯**: http://localhost:5173/practice
2. **æ£€æŸ¥é¢˜ç›®åˆ—è¡¨**: åº”è¯¥èƒ½çœ‹åˆ°3ä¸ªç¤ºä¾‹é¢˜ç›®
3. **æµ‹è¯•SQLæ‰§è¡Œ**: å°è¯•æ‰§è¡Œ `SELECT * FROM employees`
4. **éªŒè¯ç­›é€‰åŠŸèƒ½**: æŒ‰éš¾åº¦å’ŒçŠ¶æ€ç­›é€‰é¢˜ç›®
5. **æµ‹è¯•ç­”æ¡ˆæäº¤**: æäº¤æ­£ç¡®SQLæŸ¥çœ‹ç»“æœ

è¿™ä¸ªç«‹å³å®æ–½æŒ‡å—åŒ…å«äº†æ‰€æœ‰å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ä»£ç ï¼Œå¤åˆ¶ç²˜è´´å³å¯çœ‹åˆ°æ•ˆæœï¼Œå¸®åŠ©ä½ å¿«é€ŸéªŒè¯ä¼˜åŒ–æ–¹æ¡ˆçš„å¯è¡Œæ€§ã€‚