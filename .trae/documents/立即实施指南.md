# SQL实战平台立即实施指南

## 🚀 5分钟快速启动优化

### 第一步：数据库升级（立即执行）

```bash
# 在 sql-learn-backend 目录下执行
python -m alembic revision --autogenerate -m "enhance_exercise_system"
python -m alembic upgrade head
```

### 第二步：创建优化后的API（复制粘贴即可用）

创建文件 `sql-learn-backend/app/api/v1/exercises.py`：

```python
from fastapi import APIRouter, Depends, HTTPException, Query
from sqlalchemy.orm import Session
from typing import List, Optional
from pydantic import BaseModel
from datetime import datetime

from ...database import get_db
from ...models import Exercise, User, UserExerciseRecord
from ..auth import get_current_user

router = APIRouter(prefix="/api/v1/exercises", tags=["exercises"])

class ExerciseDetail(BaseModel):
    id: int
    title: str
    description: str
    difficulty: str
    points: int
    category: str
    tags: List[str]
    sample_data: dict
    hints: List[str]
    expected_result: List[dict]

class ExerciseListParams(BaseModel):
    difficulty: Optional[str] = None
    category: Optional[str] = None
    tags: Optional[List[str]] = None
    status: Optional[str] = "all"  # all, todo, completed
    limit: int = Query(default=20, le=100)

@router.get("/list", response_model=List[dict])
def get_exercises(
    params: ExerciseListParams = Depends(),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """获取练习题列表，支持筛选和分页"""
    query = db.query(Exercise)
    
    if params.difficulty:
        query = query.filter(Exercise.difficulty == params.difficulty)
    
    # 获取用户完成记录
    completed_ids = set()
    if params.status != "all":
        records = db.query(UserExerciseRecord.exercise_id).filter(
            UserExerciseRecord.user_id == current_user.id,
            UserExerciseRecord.is_completed == (params.status == "completed")
        ).all()
        completed_ids = {r.exercise_id for r in records}
        query = query.filter(Exercise.id.in_(completed_ids) if params.status == "completed" 
                           else ~Exercise.id.in_(completed_ids))
    
    exercises = query.limit(params.limit).all()
    
    return [{
        "id": e.id,
        "title": e.title,
        "description": e.description,
        "difficulty": e.difficulty,
        "points": e.points,
        "is_completed": e.id in completed_ids
    } for e in exercises]

@router.get("/{exercise_id}", response_model=ExerciseDetail)
def get_exercise_detail(
    exercise_id: int,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """获取题目详细信息"""
    exercise = db.query(Exercise).filter(Exercise.id == exercise_id).first()
    if not exercise:
        raise HTTPException(status_code=404, detail="题目不存在")
    
    return {
        "id": exercise.id,
        "title": exercise.title,
        "description": exercise.description,
        "difficulty": exercise.difficulty,
        "points": exercise.points,
        "category": exercise.category or "基础练习",
        "tags": exercise.tags or [],
        "sample_data": exercise.sample_data or {},
        "hints": exercise.hints or [],
        "expected_result": exercise.expected_result or []
    }
```

### 第三步：前端API集成（立即可用）

创建文件 `sql-learn/src/api/exercise.ts`：

```typescript
import request from '@/utils/request'

export interface Exercise {
  id: number
  title: string
  description: string
  difficulty: 'easy' | 'medium' | 'hard'
  points: number
  is_completed: boolean
}

export interface ExerciseDetail extends Exercise {
  category: string
  tags: string[]
  sample_data: {
    tables: Array<{
      name: string
      columns: string[]
      data: Record<string, any>[]
    }>
  }
  hints: string[]
  expected_result: Record<string, any>[]
}

export const exerciseApi = {
  // 获取练习列表
  async getList(params: {
    difficulty?: string
    category?: string
    status?: 'all' | 'todo' | 'completed'
    limit?: number
  }) {
    return request.get('/api/v1/exercises/list', { params })
  },

  // 获取题目详情
  async getDetail(id: number) {
    return request.get(`/api/v1/exercises/${id}`)
  },

  // 提交答案
  async submitAnswer(exerciseId: number, sql: string, result: any) {
    return request.post('/api/v1/exercises/submit', {
      exercise_id: exerciseId,
      sql,
      result
    })
  }
}
```

### 第四步：优化练习页面（直接替换）

修改 `sql-learn/src/pages/Practice.vue`，替换现有代码：

```vue
<template>
  <div class="practice-container">
    <el-row :gutter="20">
      <!-- 左侧筛选面板 -->
      <el-col :xs="24" :lg="6">
        <el-card class="filter-card">
          <template #header>
            <div class="card-header">
              <span>筛选条件</span>
              <el-button type="primary" size="small" @click="loadExercises">
                刷新
              </el-button>
            </div>
          </template>
          
          <el-form label-position="top">
            <el-form-item label="难度">
              <el-select v-model="filters.difficulty" clearable>
                <el-option label="全部" value="" />
                <el-option label="简单" value="easy" />
                <el-option label="中等" value="medium" />
                <el-option label="困难" value="hard" />
              </el-select>
            </el-form-item>
            
            <el-form-item label="状态">
              <el-radio-group v-model="filters.status">
                <el-radio value="all">全部</el-radio>
                <el-radio value="todo">待完成</el-radio>
                <el-radio value="completed">已完成</el-radio>
              </el-radio-group>
            </el-form-item>
          </el-form>
        </el-card>

        <!-- 题目列表 -->
        <el-card class="exercise-list" style="margin-top: 20px">
          <div
            v-for="exercise in exercises"
            :key="exercise.id"
            class="exercise-item"
            :class="{ active: currentExercise?.id === exercise.id }"
            @click="selectExercise(exercise)"
          >
            <div class="exercise-header">
              <el-tag :type="getDifficultyType(exercise.difficulty)" size="small">
                {{ exercise.difficulty }}
              </el-tag>
              <el-icon v-if="exercise.is_completed" color="#67C23A">
                <Check />
              </el-icon>
            </div>
            <h4>{{ exercise.title }}</h4>
            <p>{{ exercise.description }}</p>
          </div>
        </el-card>
      </el-col>

      <!-- 右侧答题区域 -->
      <el-col :xs="24" :lg="18">
        <div v-if="currentExercise" class="exercise-workspace">
          <!-- 题目详情 -->
          <el-card>
            <template #header>
              <div class="card-header">
                <h3>{{ currentExercise.title }}</h3>
                <el-tag :type="getDifficultyType(currentExercise.difficulty)">
                  {{ currentExercise.difficulty }}
                </el-tag>
              </div>
            </template>
            
            <div class="exercise-content">
              <h4>题目描述</h4>
              <p>{{ currentExercise.description }}</p>
              
              <h4>示例数据</h4>
              <div class="sample-tables">
                <div
                  v-for="table in currentExercise.sample_data.tables"
                  :key="table.name"
                  class="sample-table"
                >
                  <h5>{{ table.name }}</h5>
                  <el-table :data="table.data" size="small">
                    <el-table-column
                      v-for="col in table.columns"
                      :key="col"
                      :prop="col"
                      :label="col"
                    />
                  </el-table>
                </div>
              </div>
            </div>
          </el-card>

          <!-- SQL编辑器 -->
          <el-card style="margin-top: 20px">
            <template #header>
              <div class="card-header">
                <h3>SQL编辑器</h3>
                <div>
                  <el-button
                    type="success"
                    :loading="executing"
                    @click="executeSQL"
                  >
                    <el-icon><CaretRight /></el-icon>
                    运行
                  </el-button>
                  <el-button
                    type="primary"
                    :disabled="!executeResult"
                    @click="submitAnswer"
                  >
                    <el-icon><Check /></el-icon>
                    提交答案
                  </el-button>
                </div>
              </div>
            </template>
            
            <el-input
              v-model="sqlCode"
              type="textarea"
              :rows="8"
              placeholder="在此输入SQL查询语句..."
            />
          </el-card>

          <!-- 查询结果 -->
          <el-card v-if="executeResult" style="margin-top: 20px">
            <template #header>
              <div class="card-header">
                <h3>查询结果</h3>
                <span>共 {{ executeResult.row_count }} 条记录</span>
              </div>
            </template>
            
            <el-table :data="executeResult.data" max-height="400">
              <el-table-column
                v-for="col in executeResult.columns"
                :key="col"
                :prop="col"
                :label="col"
              />
            </el-table>
          </el-card>

          <!-- 错误提示 -->
          <el-alert
            v-if="executeError"
            :title="executeError"
            type="error"
            show-icon
            style="margin-top: 20px"
          />
        </div>

        <el-empty v-else description="请选择一道题目开始练习" />
      </el-col>
    </el-row>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { ElMessage } from 'element-plus'
import { exerciseApi } from '@/api/exercise'
import { sqlApi } from '@/api/sql'

const filters = ref({
  difficulty: '',
  status: 'all'
})

const exercises = ref([])
const currentExercise = ref(null)
const sqlCode = ref('')
const executing = ref(false)
const executeResult = ref(null)
const executeError = ref('')

const loadExercises = async () => {
  try {
    const response = await exerciseApi.getList(filters.value)
    exercises.value = response.data
  } catch (error) {
    ElMessage.error('加载题目失败')
  }
}

const selectExercise = (exercise: any) => {
  currentExercise.value = exercise
  sqlCode.value = ''
  executeResult.value = null
  executeError.value = ''
}

const executeSQL = async () => {
  if (!sqlCode.value.trim()) {
    ElMessage.warning('请输入SQL语句')
    return
  }
  
  executing.value = true
  executeError.value = ''
  
  try {
    const response = await sqlApi.execute({
      sql: sqlCode.value,
      exercise_id: currentExercise.value?.id
    })
    
    if (response.data.success) {
      executeResult.value = response.data
    } else {
      executeError.value = response.data.error_message
    }
  } catch (error) {
    executeError.value = '执行失败，请检查SQL语法'
  } finally {
    executing.value = false
  }
}

const submitAnswer = async () => {
  if (!executeResult.value) return
  
  try {
    await exerciseApi.submitAnswer(
      currentExercise.value.id,
      sqlCode.value,
      executeResult.value
    )
    ElMessage.success('答案提交成功！')
    loadExercises() // 刷新状态
  } catch (error) {
    ElMessage.error('提交失败')
  }
}

const getDifficultyType = (difficulty: string) => {
  const map = {
    easy: 'success',
    medium: 'warning',
    hard: 'danger'
  }
  return map[difficulty] || 'info'
}

onMounted(() => {
  loadExercises()
})
</script>

<style scoped>
.practice-container {
  padding: 20px;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.exercise-item {
  padding: 15px;
  border: 1px solid #eee;
  border-radius: 8px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.3s;
}

.exercise-item:hover {
  border-color: #409EFF;
  box-shadow: 0 2px 8px rgba(64, 158, 255, 0.2);
}

.exercise-item.active {
  border-color: #409EFF;
  background-color: rgba(64, 158, 255, 0.1);
}

.exercise-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.sample-tables {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.sample-table h5 {
  margin-bottom: 10px;
  color: #606266;
}
</style>
```

### 第五步：测试数据（立即导入）

创建文件 `sql-learn-backend/data/sample_exercises.sql`：

```sql
-- 插入示例题目数据
INSERT INTO exercises (title, description, difficulty, points, category, sample_data, expected_result, hints) VALUES
('基础查询', '查询所有员工的基本信息', 'easy', 10, '基础查询', 
'{"tables": [{"name": "employees", "columns": ["id", "name", "department", "salary"], "data": [{"id": 1, "name": "张三", "department": "技术部", "salary": 8000}, {"id": 2, "name": "李四", "department": "销售部", "salary": 6000}]}]}',
'[{"id": 1, "name": "张三", "department": "技术部", "salary": 8000}, {"id": 2, "name": "李四", "department": "销售部", "salary": 6000}]',
'["使用SELECT * FROM employees", "注意表名的大小写"]'),

('条件查询', '查询工资大于7000的员工', 'medium', 15, '条件查询',
'{"tables": [{"name": "employees", "columns": ["id", "name", "department", "salary"], "data": [{"id": 1, "name": "张三", "department": "技术部", "salary": 8000}, {"id": 2, "name": "李四", "department": "销售部", "salary": 6000}, {"id": 3, "name": "王五", "department": "技术部", "salary": 7500}]}]}',
'[{"id": 1, "name": "张三", "department": "技术部", "salary": 8000}, {"id": 3, "name": "王五", "department": "技术部", "salary": 7500}]',
'["使用WHERE子句进行条件筛选", "比较运算符的使用"]'),

('聚合查询', '统计每个部门的平均工资', 'hard', 20, '聚合查询',
'{"tables": [{"name": "employees", "columns": ["id", "name", "department", "salary"], "data": [{"id": 1, "name": "张三", "department": "技术部", "salary": 8000}, {"id": 2, "name": "李四", "department": "销售部", "salary": 6000}, {"id": 3, "name": "王五", "department": "技术部", "salary": 7500}, {"id": 4, "name": "赵六", "department": "销售部", "salary": 6500}]}]}',
'[{"department": "技术部", "avg_salary": 7750}, {"department": "销售部", "avg_salary": 6250}]',
'["使用GROUP BY进行分组", "使用AVG()聚合函数", "注意GROUP BY的语法"]');

-- 插入分类数据
INSERT INTO exercise_categories (name, description, icon, sort_order) VALUES
('基础查询', 'SELECT语句的基本使用', 'document', 1),
('条件查询', 'WHERE子句和条件筛选', 'filter', 2),
('聚合查询', 'GROUP BY和聚合函数', 'data-analysis', 3),
('连接查询', '多表连接操作', 'link', 4),
('子查询', '嵌套查询语句', 'share', 5);
```

### 启动命令

```bash
# 1. 启动后端
cd sql-learn-backend
pip install -r requirements.txt
python -m uvicorn app.main:app --reload --port 8000

# 2. 启动前端
cd sql-learn
npm install
npm run dev

# 3. 导入测试数据
cd sql-learn-backend
python -c "from app.database import SessionLocal; from app.models import *; db = SessionLocal(); exec(open('data/sample_exercises.sql').read())"
```

## ✅ 验证步骤

1. **访问前端**: http://localhost:5173/practice
2. **检查题目列表**: 应该能看到3个示例题目
3. **测试SQL执行**: 尝试执行 `SELECT * FROM employees`
4. **验证筛选功能**: 按难度和状态筛选题目
5. **测试答案提交**: 提交正确SQL查看结果

这个立即实施指南包含了所有可以直接使用的代码，复制粘贴即可看到效果，帮助你快速验证优化方案的可行性。